<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audio Card</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#c9c9c9;
  font-family:sans-serif;
}

.wrapper{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card{
  width:320px;
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 14px 38px rgba(0,0,0,.17);
  z-index:2;
}

/* ART */
.art{
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 10px 22px rgba(0,0,0,.14);
}

.art img{
  width:100%;
  display:block;
}

/* TEXT */
.caption{
  margin-top:10px;
  padding:6px 4px;
  font-size:14px;
  color:#555;
  text-align:center;
  min-height:22px;
}

/* CONTROLS */
.controls{
  margin-top:8px;
}

audio{
  width:100%;
  border-radius:8px;
}

.canvas-spectrum{
  width:100%;
  height:55px;
  margin-top:10px;
}

/* SNOW */
#snow{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:1;
}
</style>
</head>

<body>

<canvas id="snow"></canvas>

<div class="wrapper">
  <div class="card">

    <div class="art">
      <img src="art.jpg">
    </div>

    <!-- TEXT PLACE -->
    <div class="caption">
      مثل یه تست دوست‌داشتنی
    </div>

    <div class="controls">
      <audio id="audio" controls src="song.mp3"></audio>
      <canvas id="spectrum" class="canvas-spectrum"></canvas>
    </div>

  </div>
</div>

<script>
/* ===== AUDIO + WAVEFORM ===== */
const audio = document.getElementById("audio");
const canvas = document.getElementById("spectrum");
const ctx = canvas.getContext("2d");

let audioCtx, analyser, source, ready = false;

function initAudio(){
  if(ready) return;
  audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  source = audioCtx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
  ready = true;
}

function resizeSpectrum(){
  const r = canvas.getBoundingClientRect();
  const dpr = devicePixelRatio || 1;
  canvas.width = r.width * dpr;
  canvas.height = r.height * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeSpectrum();
addEventListener("resize", resizeSpectrum);

const data = new Uint8Array(1024);

function drawSpectrum(){
  requestAnimationFrame(drawSpectrum);
  if(!ready) return;

  analyser.getByteTimeDomainData(data);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  const mid = h/2;

  ctx.fillStyle = "rgba(255,255,255,.85)";
  ctx.shadowColor = "rgba(0,0,0,.28)";
  ctx.shadowBlur = 8;

  ctx.beginPath();
  ctx.moveTo(0, mid);

  for(let i=0;i<data.length;i++){
    const x = (i/data.length) * w;
    const v = (data[i]-128)/128;
    ctx.lineTo(x, mid + v * mid * 0.85);
  }

  ctx.lineTo(w, mid);
  ctx.lineTo(w, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  ctx.fill();

  ctx.shadowBlur = 0;
}
drawSpectrum();

/* ===== SNOW (REAL RANDOM & DEPTH) ===== */
const snow = document.getElementById("snow");
const sc = snow.getContext("2d");

function resizeSnow(){
  const dpr = devicePixelRatio || 1;
  snow.width = innerWidth * dpr;
  snow.height = innerHeight * dpr;
  sc.setTransform(dpr,0,0,dpr,0,0);
}
resizeSnow();
addEventListener("resize", resizeSnow);

const flakes = Array.from({ length: 150 }, () => {
  const r = Math.random() * 2.6 + 0.4;
  return {
    x: Math.random()*innerWidth,
    y: Math.random()*innerHeight,
    r,
    vy: 0.15 + r * 0.35,
    drift: 0.2 + r * 0.6,
    alpha: 0.4 + Math.random() * 0.6,
    blur: r > 2 ? 1.5 : 0,
    phase: Math.random()*Math.PI*2
  };
});

let opacity = 0, target = 0, last = performance.now();

function drawSnow(t){
  requestAnimationFrame(drawSnow);
  const dt = t-last; last = t;
  opacity += (target-opacity)*Math.min(dt/2000,1);

  sc.clearRect(0,0,snow.width,snow.height);

  flakes.forEach(f=>{
    f.phase += 0.008;
    f.y += f.vy;
    f.x += Math.sin(f.phase) * f.drift;

    sc.save();
    sc.globalAlpha = opacity * f.alpha;
    sc.filter = `blur(${f.blur}px)`;
    sc.fillStyle = "#ededed";
    sc.beginPath();
    sc.arc(f.x,f.y,f.r,0,Math.PI*2);
    sc.fill();
    sc.restore();

    if(f.y > innerHeight + 10){
      f.y = -10;
      f.x = Math.random()*innerWidth;
    }
  });
}
drawSnow(performance.now());

audio.addEventListener("play",()=>{
  initAudio();
  audioCtx.resume();
  target = 1;
});
audio.addEventListener("pause",()=>target=0);
audio.addEventListener("ended",()=>target=0);
</script>

</body>
</html>
